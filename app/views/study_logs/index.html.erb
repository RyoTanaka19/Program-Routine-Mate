<% content_for(:title, t('.title')) %>
<h1>å­¦ç¿’è¨˜éŒ²ä¸€è¦§</h1>
<%= render 'search_form', q: @q, url: study_logs_path %>

<br>

<div class="w-full flex lg:items-center flex-col">
  <!-- ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®è¡¨ç¤ºé ˜åŸŸ -->
  <div id="cal-heatmap" class="overflow-auto md:overflow-scroll"></div>
</div>

<script>
  // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°ã‚’å³æ™‚ã«å®Ÿè¡Œ
  set_heatmap(); 

  function set_heatmap() {
    let startDate = new Date();
    startDate.setMonth(startDate.getMonth() - 2);
    console.log(startDate);

    let data = <%= @contribution_graph.to_json.html_safe %>;

    data = data.map(item => ({
      date: new Date(item.date).toISOString(),
      total: item.total
    }));

    const cal = new CalHeatmap();

    cal.paint({
      itemSelector: '#cal-heatmap',
      domain: {
        type: 'month',
        gutter: 4,
        label: { 
          text: 'MMM',
          textAlign: 'start',
          position: 'top',
        },
      },
      subDomain: {
        type: 'ghDay',
        radius: 2,
        width: 11,
        height: 11,
        gutter: 4,
      },
      date: { start: startDate },
      range: 12,
      data: { 
        source: data,
        x: 'date',
        y: 'total'
      },
      type: 'json',
      scale: {
        color: {
          type: 'linear',
          range: ['#ff4d4d', '#a8e6a2', '#6abf4f', '#337d2b', '#175e17'],
          domain: [0, 0.1, 1, 2, 3],
        },
      },
    });

    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ç™»éŒ²
    cal.on('click', (event, timestamp, value) => {
      if (!timestamp) {
        console.log('ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚»ãƒ«ã«æ—¥ä»˜ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      const clickedDate = new Date(timestamp).toISOString().slice(0, 10);
      console.log('ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ—¥ä»˜:', clickedDate);
      fetchStudyLogsByDate(clickedDate);
    });
  }

  // â˜… ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ—¥ä»˜ã®å­¦ç¿’ãƒ­ã‚°ã‚’å–å¾—ã—ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º â˜…
  function fetchStudyLogsByDate(date) {
    fetch(`/study_logs/logs_by_date?date=${date}`, {
      headers: { 'Accept': 'application/json' }
    })
    .then(response => {
      if (response.status === 401) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚");
        window.location.href = "/users/sign_in";
        return;
      }

      if (!response.ok) throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼");
      return response.json();
    })
    .then(data => {
      if (data) showLogsModal(date, data);
    })
    .catch(error => {
      alert("ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: " + error.message);
    });
  }

  // â˜… ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º â˜…
  function showLogsModal(date, logs) {
    const modal = document.getElementById("logs-modal");
    const list = document.getElementById("logs-list");
    const title = document.getElementById("modal-title");

    title.textContent = `${date} ã®å­¦ç¿’è¨˜éŒ²`;
    list.innerHTML = "";

    if (logs.length === 0) {
      list.innerHTML = "<li>ã“ã®æ—¥ã®æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>";
    } else {
      logs.forEach(log => {
        const item = document.createElement("li");
        item.innerHTML = `
          <div class="p-3 border rounded shadow-sm bg-gray-50">
            <div class="font-bold">${log.study_genre?.name || 'æœªåˆ†é¡'}: ${log.content}</div>
            <div class="text-sm text-gray-600 mt-1">${log.text || ''}</div>
            <div class="text-xs text-gray-400 mt-1">æŠ•ç¨¿æ—¥: ${new Date(log.created_at).toLocaleString()}</div>
          </div>
        `;
        list.appendChild(item);
      });
    }

    modal.classList.remove("hidden");
  }

  // â˜… ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º â˜…
  function closeModal() {
    document.getElementById("logs-modal").classList.add("hidden");
  }
</script>


<br>


<!-- æŠ•ç¨¿ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="flex flex-wrap gap-4 justify-center">
  <% @study_logs.each do |study_log| %>
    <div class="w-80 mb-4 flex flex-col border p-4 rounded-lg shadow-md bg-white hover:bg-gray-100">
      <%= link_to study_log_path(study_log), class: "block flex flex-col h-full" , data: { action: "click->loading#show" } do %>

        <!-- æŠ•ç¨¿æ—¥æ™‚ã¨å­¦ç¿’æ™‚é–“ -->
        <div class="text-sm text-gray-600 mb-2">
          <p><strong>æŠ•ç¨¿æ—¥:</strong> <%= study_log.date %></p>
        </div>

        <!-- ã‚¸ãƒ£ãƒ³ãƒ« -->
        <p class="text-sm text-gray-600"><strong>ã‚¸ãƒ£ãƒ³ãƒ«:</strong> <%= study_log.study_genre.present? ? study_log.study_genre.name : "æœªè¨­å®š" %></p>

        <!-- å­¦ç¿’å†…å®¹ -->
        <p class="text-sm mb-2">å­¦ç¿’å†…å®¹: <%= study_log.content %></p>

        <!-- æŠ•ç¨¿ç”»åƒ -->
        <%= image_tag(study_log.image? ? study_log.image_url : "default_study_logs_image.png", class: "w-full h-auto rounded-md mb-2") %>

        <!-- ã„ã„ã­ -->
        <div class="flex items-center gap-1 text-gray-700 text-lg mt-2">
          <span class="text-xl">ğŸ‘</span>
          <span><%= study_log.likes.count %></span>
        </div>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ -->
        <div class="text-xs mt-2">
          <% if user_signed_in? && current_user == study_log.user %>
            <span style="color: green;">âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­</span>
          <% else %>
            <span style="color: red;">âŒ æœªãƒ­ã‚°ã‚¤ãƒ³</span>
          <% end %>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å (å³ä¸‹ã«è¡¨ç¤º) -->
        <div class="mt-auto text-xs text-right text-blue-600">
          <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> <%= study_log.user.name %></p>
        </div>

      <% end %>
    </div>
  <% end %>
</div>



<%= paginate @study_logs %>

<!-- â˜… ãƒ¢ãƒ¼ãƒ€ãƒ«ã®HTML â˜… -->
<div id="logs-modal" class="fixed z-50 inset-0 bg-black bg-opacity-50 hidden">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl mx-auto mt-20">
    <h2 class="text-lg font-semibold mb-4" id="modal-title"></h2>
    <ul id="logs-list" class="space-y-2 text-gray-700 max-h-[50vh] overflow-y-auto"></ul>
    <button onclick="closeModal()" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">é–‰ã˜ã‚‹</button>
  </div>
</div>
