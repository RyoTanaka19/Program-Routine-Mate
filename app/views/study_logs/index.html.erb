<%= render 'search_form', q: @q, url: study_logs_path %>

<br>

<div class="w-full flex lg:items-center flex-col">
  <!-- ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®è¡¨ç¤ºé ˜åŸŸ -->
  <div id="cal-heatmap" class="overflow-auto md:overflow-scroll"></div>
</div>

<script>
let cal = null; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒã™ã‚‹ CalHeatmap ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

document.addEventListener("turbo:load", initHeatmap);

function initHeatmap() {
  console.log("initHeatmap called");
  const container = document.getElementById("cal-heatmap");
  if (!container) return;

  set_heatmap();
}

function set_heatmap() {
  // æ—¢ã«æç”»æ¸ˆã¿ãªã‚‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç ´æ£„ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚¯ãƒªã‚¢
  if (cal !== null) {
    cal.destroy();
    cal = null;
  }

  const container = document.getElementById("cal-heatmap");
  if (container) container.innerHTML = "";  // â†ã“ã‚ŒãŒé‡è¦

  let startDate = new Date();
  startDate.setMonth(startDate.getMonth() - 2);

  let data = <%= @contribution_graph.to_json.html_safe %>;

  data = data.map(item => ({
    date: new Date(item.date).toISOString(),
    total: item.total
  }));

  cal = new CalHeatmap();

  cal.paint({
    itemSelector: '#cal-heatmap',
    domain: {
      type: 'month',
      gutter: 4,
      label: {
        text: 'MMM',
        textAlign: 'start',
        position: 'top',
      },
    },
    subDomain: {
      type: 'ghDay',
      radius: 2,
      width: 11,
      height: 11,
      gutter: 4,
    },
    date: { start: startDate },
    range: 12,
    data: {
      source: data,
      x: 'date',
      y: 'total'
    },
    type: 'json',
    scale: {
      color: {
        type: 'linear',
        range: ['#d0f0c0', '#a8e6a2', '#6abf4f', '#337d2b', '#175e17'],
        domain: [0, 0.5, 1, 2, 4],
      },
    },
  });

  cal.on('click', (event, timestamp, value) => {
    if (!timestamp) {
      console.log('ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚»ãƒ«ã«æ—¥ä»˜ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    const clickedDate = new Date(timestamp).toISOString().slice(0, 10);
    fetchStudyLogsByDate(clickedDate);
  });
}


function fetchStudyLogsByDate(date) {
  fetch(`/study_logs/logs_by_date?date=${date}`, {
    headers: { 'Accept': 'application/json' }
  })
  .then(response => {
    if (response.status === 401) {
      alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚");
      window.location.href = "/users/sign_in";
      return Promise.reject("Unauthorized"); // ã“ã“ã§Promiseãƒã‚§ãƒ¼ãƒ³ã‚’ä¸­æ–­
    }

    if (!response.ok) throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼");
    return response.json();
  })
  .then(data => {
    if (data) showLogsModal(date, data);
  })
  .catch(error => {
    alert("ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: " + error.message);
  });
}

function showLogsModal(date, logs) {
  const modal = document.getElementById("logs-modal");
  const list = document.getElementById("logs-list");
  const title = document.getElementById("modal-title");

  // ã“ã“ã¯ã€Œyyyy-mm-ddã€å½¢å¼ã®ã¾ã¾è¡¨ç¤ºã€å¿…è¦ãªã‚‰åˆ¥é€”ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚ºå¯¾å¿œæ¤œè¨
  title.textContent = `${date} ã®å­¦ç¿’è¨˜éŒ²`;
  list.innerHTML = "";

  if (logs.length === 0) {
    list.innerHTML = "<li>ã“ã®æ—¥ã®æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>";
  } else {
    logs.forEach(log => {
      const item = document.createElement("li");
      item.innerHTML = `
        <div class="p-3 border rounded shadow-sm bg-gray-50">
          <div class="font-bold">${log.study_genre?.name || 'æœªåˆ†é¡'}: ${log.content}</div>
          <div class="text-sm text-gray-600 mt-1">${log.text || ''}</div>
          <div class="text-xs text-gray-400 mt-1">æŠ•ç¨¿æ—¥: ${new Date(log.created_at).toLocaleString()}</div>
        </div>
      `;
      list.appendChild(item);
    });
  }

  modal.classList.remove("hidden");
}

document.addEventListener("turbo:load", () => {
  const closeBtn = document.getElementById("modal-close-btn");
  if (closeBtn) {
    closeBtn.addEventListener("click", closeModal);
  }
});

function closeModal() {
  const modal = document.getElementById("logs-modal");
  if (modal) modal.classList.add("hidden");
}

</script>

<!-- ä»¥ä¸‹ç•¥ -->


<br>

<!-- æŠ•ç¨¿ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="flex flex-wrap gap-3 justify-center">
  <% @study_logs.each do |study_log| %>
    <div class="w-64 h-[340px] mb-3 flex flex-col border p-2 rounded-md shadow bg-white hover:bg-gray-100">
      <%= link_to study_log_path(study_log), class: "flex flex-col h-full justify-between", data: { action: "click->loading#show" } do %>

        <!-- ä¸­å¤®å¯„ã›ã™ã‚‹ä¸­èº«å…¨ä½“ã‚’å›²ã‚€ -->
        <!-- ä¸­å¤®å¯„ã›ã™ã‚‹ä¸­èº«å…¨ä½“ã‚’å›²ã‚€ï¼ˆå°‘ã—ä¸‹ã«å¯„ã›ï¼‰ -->
<div class="flex-1 flex flex-col justify-end mt-1">
  <!-- ç”»åƒï¼ˆã‚µã‚¤ã‚ºæ‹¡å¤§ + é–“éš”èª¿æ•´ï¼‰-->
  <div class="mb-1 overflow-hidden rounded-md">
    <%= image_tag(
      study_log.image? ? study_log.image_url : "default_study_logs_image.png",
      class: "w-full h-32 object-cover rounded"
    ) %>
  </div>

  <!-- å­¦ç¿’å†…å®¹ -->
  <p class="text-[12px] font-medium text-gray-800 mb-2 line-clamp-2">
    å­¦ç¿’å†…å®¹: <%= study_log.content %>
  </p>

  <!-- ã‚¸ãƒ£ãƒ³ãƒ« -->
  <p class="text-[11px] text-gray-600 leading-tight mb-1">
    ğŸ“š <strong>ã‚¸ãƒ£ãƒ³ãƒ«:</strong>
    <%= study_log.study_genre&.display_name || "æœªè¨­å®š" %>
  </p>

  <!-- æŠ•ç¨¿æ—¥ -->
  <p class="text-[11px] text-gray-600 leading-tight mb-2">
    ğŸ—“ï¸ <strong>æ—¥:</strong> <%= study_log.date %>
  </p>

 <!-- ã„ã„ã­ -->
<div class="flex items-center space-x-1 text-[11px] mb-2">
  <%= render 'study_likes/like_button', study_log: study_log %>
  <%= turbo_frame_tag "like-count-#{study_log.id}" do %>
    <span class="text-gray-700"><%= study_log.study_likes.count %></span>
  <% end %>
</div>


  <!-- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ -->
  <div class="text-[10px] text-gray-500 leading-none mb-1">
    <% if user_signed_in? && current_user == study_log.user %>
      âœ… <span class="text-green-600">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</span>
    <% else %>
      âŒ <span class="text-red-500">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
    <% end %>
  </div>
</div>


        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆä¸‹éƒ¨å›ºå®šï¼‰ -->
        <div class="flex items-center justify-end space-x-1 mt-2 text-[11px] text-blue-600">
  <%= link_to user_path(study_log.user), class: "flex items-center space-x-1" do %>
    <%= image_tag(
      study_log.user.profile_image? ? study_log.user.profile_image_url : "default_study_logs_image.png",
      class: "w-5 h-5 rounded-full object-cover border border-blue-400"
    ) %>
    <span><%= study_log.user.name %></span>
  <% end %>
</div>
      <% end %>
    </div>
  <% end %>
</div>



<div data-controller="loading">
  <!-- `a` ã‚¿ã‚°ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ loading#show ãŒå‘¼ã°ã‚Œã‚‹ -->
  <div data-action="click->loading#show">
    <%= paginate @study_logs %>
  </div>
</div>

<!-- â˜… ãƒ¢ãƒ¼ãƒ€ãƒ«ã®HTML â˜… -->
<div id="logs-modal" class="fixed z-50 inset-0 bg-black bg-opacity-50 hidden">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl mx-auto mt-20">
    <h2 class="text-lg font-semibold mb-4" id="modal-title"></h2>
    <ul id="logs-list" class="space-y-2 text-gray-700 max-h-[50vh] overflow-y-auto"></ul>
    <button id="modal-close-btn" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">é–‰ã˜ã‚‹</button>
  </div>
</div>
