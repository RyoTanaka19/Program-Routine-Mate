var Y=Object.defineProperty;var Q=(a,e,t)=>e in a?Y(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var c=(a,e,t)=>(Q(a,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();class A{constructor(e){this.subscribers=e}changeSubscribers(e){this.subscribers=e}notify(){this.subscribers.forEach(e=>e.receive())}}class y{constructor(e,t="compassSpotTemplateFrame"){c(this,"frameElement");c(this,"windowObject",window);c(this,"onClose");var s,n;this.encryptedSpotId=e,this.id=t;const i=document.getElementById(t),r=document.getElementById(e);i!=null&&(i==null?void 0:i.nodeName)==="IFRAME"?this.frameElement=i:(this.frameElement=this.createTemplateFrameElement(),r.appendChild(this.frameElement)),this.onClose=(n=(s=this.windowObject.microadCompass)==null?void 0:s.overridingHandler)==null?void 0:n.onClose}getFrameElement(){return this.frameElement}selectElement(e){return this.getContentDocument().getElementById(e)}selectWindow(){return this.frameElement.contentWindow}createTemplateFrameElement(){const e=document.createElement("iframe");return e.id=this.id,e.setAttribute("allowFullScreen","true"),e.setAttribute("allowTransparency","true"),e.setAttribute("border",""),e.style.border="0",e}writeContents(e){this.getContentDocument().open();const t=`${e.html||""}${e.css||""}${e.js||""}`;this.getContentDocument().write(`<html><head></head><body>${t}</body></html>`),this.getContentDocument().close(),this.getContentDocument().body.style.margin="0"}hideFrameElement(){this.updateStyles({display:"none"}),this.onClose!=null&&this.onClose()}updateStyles(e){Object.entries(e).forEach(([t,i])=>{t in this.frameElement.style&&(this.frameElement.style[t]=i)})}deleteAllBodyChildrenElements(){const{body:e}=this.getContentDocument();for(;e.firstChild!=null;)e.removeChild(e.firstChild)}activeScroll(){this.getContentDocument().body.removeEventListener("touchmove",this.preventDefault),this.getContentDocument().body.removeEventListener("wheel",this.preventDefault)}inactiveScroll(){this.getContentDocument().body.addEventListener("touchmove",this.preventDefault,{passive:!1}),this.getContentDocument().body.addEventListener("wheel",this.preventDefault,{passive:!1})}preventDefault(e){e==null||e.preventDefault()}getContentDocument(){let e;for(;(e=this.frameElement.contentDocument)==null;);return e}replaceText(e,t){const i=this.getContentDocument().getElementById(e);i!=null&&(i.innerText=t)}}class U{constructor(e){c(this,"templateFrameRepository");this.encryptedSpotId=e,this.templateFrameRepository=new y(e)}receive(){this.templateFrameRepository.hideFrameElement(),this.templateFrameRepository.activeScroll()}}class Z{executeRequest(e){const t="https://s-rtb.send.microad.jp/ad",i=e?`${t}?${e}`:t;this.sendRequestByJSONP(i)}sendRequestByJSONP(e){var r;const t=document.getElementsByTagName("script")[0],i=document.createElement("script");return i.type="text/javascript",i.defer=!0,i.src=e,(r=t.parentNode)==null||r.insertBefore(i,t),i}}class z{constructor(e,t,i){c(this,"adRequestRepository");c(this,"templateFrameRepository");this.adRequest=e,this.adResponse=t,this.selectedAudienceIds=i,this.adRequestRepository=new Z,this.templateFrameRepository=new y(t.getEncryptedSpotId())}receive(){const e=this.adResponse.getRotationMax(),t=this.adResponse.getSequence();if(e==null||t==null)throw new Error("[COMPASS-JS] Cant read rotation_max or sequence. therefore, next advertisement is not display.");if(!this.adResponse.isExecutableRotation()){this.templateFrameRepository.hideFrameElement();return}if(this.adRequest.getEncryptedSpotId()==null)return;const i=this.adResponse.createRotationParams();this.adRequestRepository.executeRequest(this.adRequest.createRequestURL(i,this.selectedAudienceIds))}}class I{getStyle(e,t){return e.style[t]}createFrameElement(e,t){const i=document.createElement("iframe");return i.id=e,i.setAttribute("allowFullScreen","true"),i.setAttribute("allowTransparency","true"),i.setAttribute("border",""),i.style.border="0",t!=null&&t.width&&(i.style.width=`${t.width}px`),t!=null&&t.height&&(i.style.height=`${t.height}px`),i}writeIFrameContents(e,t,i){const r=this.getContentDocument(e);r.open();const s=i!=null?`${i.width}px`:"fit-content",n=i!=null?`${i.height}px`:"fit-content",o=`<body style="margin: 0; width: ${s}; height: ${n}; overflow: hidden;">`,l=`${t.html||""}${t.css||""}${t.js||""}`;r.write(`<html><head></head>${o}${l}</body></html>`),r.close(),i&&(r.body.style.minWidth="200px"),this.inactiveScroll(r)}observeIframeContentSize(e){const t=this.getContentDocument(e);new ResizeObserver(()=>{e.style.width=`${t.body.offsetWidth}px`,e.style.height=`${t.body.offsetHeight}px`}).observe(t.body)}observeSize(e,t){new ResizeObserver(()=>{e.style.width=`${t.offsetWidth}px`,e.style.height=`${t.offsetHeight}px`}).observe(t)}append(e,t){e.appendChild(t)}appendSameElement(e,t,i){Object.keys([...Array(i)]).forEach(()=>{e.appendChild(document.createElement(t))})}addCssClass(e,t){e.className=t}removeAll(e){for(;e.firstChild!=null;)e.removeChild(e.firstChild)}clickBy(e){const t=this.getClickEventTargetElement(e);if(t==null)return;t.click()}inactiveClickOrTouch(e){e.style.pointerEvents="none"}updateStyles(e,t){e!=null&&Object.entries(t).forEach(([i,r])=>{i in e.style&&e.style[i]!=null&&(e.style[i]=r)})}activeFocusEvent(e,t,i){e.addEventListener("focus",t),e.addEventListener("blur",i)}inactiveFocusEvent(e,t,i){e.removeEventListener("focus",t),e.removeEventListener("blur",i)}activeTouchMoveEvent(e,t){e.addEventListener("touchmove",t)}inactiveTouchMoveEvent(e,t){e.removeEventListener("touchmove",t)}activeMovePageHistoryEvent(e,t,i){e.history.replaceState(null,"",null),e.addEventListener("pagehide",i),e.addEventListener("pageshow",t)}inactiveMovePageHistoryEvent(e,t,i){e.removeEventListener("pagehide",i),e.removeEventListener("pageshow",t)}preventAnchorClick(e,t){if(e==null||t==null)return;const i=this.getClickEventTargetElement(e);e.addEventListener("click",r=>{r.preventDefault(),(i==null?void 0:i.href)!=null&&t(i.href)})}getClickEventTargetElement(e){if(["a","A"].includes(e.nodeName))return e;let t;return Array.from(e.childNodes).forEach(i=>{t==null&&(t=this.getClickEventTargetElement(i))}),t}getContentDocument(e){let t;do t=e.contentDocument;while(e.contentDocument==null);return t}inactiveScroll(e){e.body.addEventListener("touchmove",this.preventDefault,{passive:!1}),e.body.addEventListener("wheel",this.preventDefault,{passive:!1})}preventDefault(e){e==null||e.preventDefault()}findElementById(e,t){return e.getElementById(t)}}class V{constructor(e,t,i,r){c(this,"templateRepository");c(this,"templateFrameRepository");c(this,"template");if(this.maybeTemplate=e,this.encryptedSpotId=t,this.styleItems=i,this.isOverlay=r,e==null||!Object.values(e).length)throw new Error("[COMPASS-JS] Cant read spot template. therefore, advertisement is not display.");this.template=e,this.templateRepository=new I,this.templateFrameRepository=new y(t)}rendering(){this.templateFrameRepository.writeContents(this.template),this.templateFrameRepository.updateStyles(this.styleItems),this.templateFrameRepository.inactiveScroll(),this.isOverlay||this.observeSpotTemplateSize()}observeSpotTemplateSize(e="compassSpotTemplate"){const t=this.templateFrameRepository.getFrameElement(),i=this.templateFrameRepository.selectElement(e);if(t==null||i==null)throw new Error("[COMPASS-JS] Cant find either spot temprate or iframe");this.templateRepository.observeSize(t,i)}}const K={position:"fixed",zIndex:"2147483647",top:"0",left:"0",width:"100%",height:"100%"};class ee{constructor(e,t){c(this,"templateRepository");c(this,"templateFrameRepository");c(this,"rendering",(e,t)=>{if(e==null)return;const i=this.templateFrameRepository.selectElement(this.id);if(i==null)return;this.templateRepository.removeAll(i);const r=this.templateRepository.createFrameElement("compassSpotTemplateAdWrapper",t);this.templateRepository.append(i,r),this.templateRepository.writeIFrameContents(r,e,t),t==null&&this.templateRepository.observeIframeContentSize(r),this.templateFrameRepository.selectElement("compassSpotTemplateAcceptButton")!=null&&this.templateRepository.inactiveClickOrTouch(i)});this.encryptedSpotId=e,this.id=t,this.templateRepository=new I,this.templateFrameRepository=new y(e)}}class te{constructor(e,t){c(this,"templateRepository");c(this,"templateFrameRepository");this.id=e,this.adResponse=t,this.templateRepository=new I,this.templateFrameRepository=new y(t.getEncryptedSpotId())}changeStorage(e){this.adResponse=e}rendering(){const e=this.templateFrameRepository.selectElement(this.id);if(e==null)return;const t=this.adResponse.getRotationMax();t!=null&&(this.templateRepository.appendSameElement(e,"div",t+1),this.receive())}receive(){const e=this.templateFrameRepository.selectElement(this.id);if(e==null)return;const t=this.adResponse.getSequence()?Number(this.adResponse.getSequence())-2:0;Array.from(e.children).forEach((i,r)=>{const s=`compassSpotTemplateRotation${t===r?"CurrentButton":"Button"}`;this.templateRepository.addCssClass(i,s)})}}class D{constructor(e,t){this.beacon=e,this.parentElement=t}fire(){const e=this.createBeaconWrapperElement();this.parentElement.appendChild(e),e.append(...this.beacon)}createBeaconWrapperElement(){const e=document.createElement("div");return e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.visibility="hidden",e}}class _{constructor(e){this.beacon=e}create(){switch(typeof this.beacon){case"string":return new D(this.convertFromString(this.beacon),document.body);default:return}}createByURL(){if(typeof this.beacon=="string"){const e=this.createImgBeacon(this.beacon);return new D(e?[e]:[],document.body)}if(Array.isArray(this.beacon)){const e=this.beacon.map(t=>this.createImgBeacon(t)).filter(t=>t!=null);return new D(e,document.body)}}convertFromString(e){const i=new DOMParser().parseFromString(e,"text/html");return i.documentElement.nodeName==="parsererror"?[]:Array.from(i.body.childNodes)}createImgBeacon(e){const t=document.createElement("img");return t.width=0,t.height=0,t.style.width="0px",t.style.height="0px",t.style.display="none",t.src=e,t}}class j{constructor(e,t,i,r,s,n,o){c(this,"maybeBeaconRepository");this.maybeMicroadCompassFrequency=t,this.adRequest=i,this.adTag=r,this.frequencyParams=s,this.targetElementId=n,this.isFirstViewing=o,this.maybeBeaconRepository=new _(e).create()}receive(){var e,t;this.adRequest!=null&&this.isFirstViewing&&((e=this.maybeMicroadCompassFrequency)==null||e.callRewardAcquisitionProcess(this.adRequest,this.adTag,this.frequencyParams,this.targetElementId)),(t=this.maybeBeaconRepository)==null||t.fire()}}class H{hideTemplate(e){new U(e).receive()}}class ie{constructor(e,t){c(this,"templateRepository");c(this,"templateFrameRepository");this.encryptedSpotId=e,this.id=t,this.templateRepository=new I,this.templateFrameRepository=new y(e)}receive(){const e=this.templateFrameRepository.selectElement(this.id);(e==null?void 0:e.contentDocument)!=null&&this.templateRepository.clickBy(e.contentDocument.body)}}class re{constructor(e){c(this,"ITUNES_REGEX",/https?:\/\/itunes\.apple\.com/);this.value=e}isTransitionByBlank(){return!(this.ITUNES_REGEX.test(this.value)||this.ITUNES_REGEX.test(decodeURIComponent(this.value)))}}class se{constructor(e,t=[]){c(this,"beaconRepositoryFactory");this.url=e,this.beaconRepositoryFactory=new _(t)}receive(){var e;this.transitionToUrl(),(e=this.beaconRepositoryFactory.createByURL())==null||e.fire()}transitionToUrl(){if(new re(this.url).isTransitionByBlank())window.open(this.url);else if(window.top!=null)window.top.location.href=this.url;else throw new Error("[COMPASS-JS] Cant find window top. therefore, cant transition to url.")}}class J{constructor(e,t,i=new I){this.templateFrameRepository=e,this.onRedirect=t,this.templateRepository=i}addListener(e="compassSpotTemplateDescription"){this.templateRepository.preventAnchorClick(this.templateFrameRepository.selectElement(e),this.onRedirect)}clickAgree(){if(this.onRedirect==null)return;const e=this.templateFrameRepository.getContentDocument(),t=this.templateRepository.findElementById(e,"compassSpotTemplateAdWrapper");if(t==null)return;const i=this.templateRepository.getContentDocument(t),r=this.templateRepository.getClickEventTargetElement(i.body);r!=null&&this.onRedirect(r.href)}}class ne{constructor(e,t,i){this.url=e,this.onRedirect=t,this.adResponse=i}receive(){this.onRedirect==null||this.url==null?new J(new y(this.adResponse.getEncryptedSpotId()),this.onRedirect).clickAgree():this.onRedirect(this.url)}}class oe{constructor(e,t){this.id=e,this.microadCompass=t}create(e){const t=e.getLandingPageUrl(),i=e.getClickTrackingUrls()||[],r=this.microadCompass.selectMicroadCompassOverridingHandler();return(r==null?void 0:r.onRedirect)!=null?new ne(t,r.onRedirect,e):t?new se(t,i):new ie(e.getEncryptedSpotId(),this.id)}}class ae{constructor(e,t,i){c(this,"templateFrameRepository");c(this,"templateRepository");c(this,"closeButton");c(this,"remainingTimeText");c(this,"rewardedText");this.encryptedSpotId=e,this.frequencyValue=t,this.frequencyParams=i,this.templateFrameRepository=new y(e),this.templateRepository=new I,this.closeButton={element:void 0,displayStyle:void 0},this.remainingTimeText={element:void 0,displayStyle:void 0},this.rewardedText={element:void 0,displayStyle:void 0}}getElementStyle(e){return e==null?{element:void 0,displayStyle:void 0}:{element:e,displayStyle:this.templateRepository.getStyle(e,"display")}}selectElements(){const e=this.templateFrameRepository.selectElement("compassSpotTemplateCloseButton");this.closeButton=this.getElementStyle(e);const t=this.templateFrameRepository.selectElement("compassSpotTemplateRemainingTimeText");this.remainingTimeText=this.getElementStyle(t);const i=this.templateFrameRepository.selectElement("compassSpotTemplateRewardedText");return this.rewardedText=this.getElementStyle(i),this}isExistRequiredElements(){return this.closeButton.element==null||this.remainingTimeText.element==null?void 0:this}hideElements(){this.templateRepository.updateStyles(this.remainingTimeText.element,{display:"none"}),this.templateRepository.updateStyles(this.rewardedText.element,{display:"none"})}rewardedCallback(){this.templateRepository.updateStyles(this.remainingTimeText.element,{display:"none"}),this.templateRepository.updateStyles(this.closeButton.element,{display:this.closeButton.displayStyle}),this.templateRepository.updateStyles(this.rewardedText.element,{display:this.rewardedText.displayStyle})}replaceRemainingTimeMacro(e){this.templateFrameRepository.replaceText("compassSpotTemplateRemainingTime",e.toString())}execute(){const{rewardedSec:e}=this.frequencyParams;if(e===0){this.rewardedCallback();return}this.templateRepository.updateStyles(this.closeButton.element,{display:"none"}),this.templateRepository.updateStyles(this.rewardedText.element,{display:"none"}),this.replaceRemainingTimeMacro(this.frequencyParams.rewardedSec),this.frequencyValue.getRemainingTimeSync(this.frequencyParams.rewardedSec,this.replaceRemainingTimeMacro.bind(this),this.rewardedCallback.bind(this))}}class ce extends H{constructor(t,i,r,s){if(!(r!=null&&r.html))throw new Error("[COMPASS-JS] Cant find template's HTML. therefore, advertisement is not display.");super();c(this,"closeClickEvent");c(this,"acceptClickEvent");c(this,"cancelClickEvent");c(this,"frame");c(this,"ad");c(this,"pager");this.microadCompass=s;const n=i.isOverlay();this.frame=new V(r,i.getEncryptedSpotId(),n?K:{},n),this.ad=new ee(i.getEncryptedSpotId(),"compassSpotTemplateMain"),this.pager=new te("compassSpotTemplateRotationContainer",i);const{adRotator:o,elementHider:l,clickThroughPlayer:h}=this.generateSubscribers(t,i);this.closeClickEvent=new A([l]),this.acceptClickEvent=new A([h,o]),this.cancelClickEvent=new A([o])}rendering(t,i){this.frame.rendering(),this.ad.rendering(i.getAd(),i.getSize()),this.pager.rendering();const r=this.microadCompass.selectMicroadCompassFrequency();this.fireImpressionBeacon(i.getImpressionTag(),r,t,i,!0);const s=i.getFrequencyParams();if(s==null)return;const n=this.microadCompass.selectMicroadCompassFrequency().getCustomKeyValues(t,s.key),o=this.microadCompass.selectMicroadCompassFrequency().selectFrequency(i.getEncryptedSpotId(),n||{},s.domain);if(o==null)throw new Error("[COMPASS-JS] Cant find registered frequency. therefore, advertisement is not display.");const l=new ae(i.getEncryptedSpotId(),o,s);l.selectElements().isExistRequiredElements()?l.execute():l.hideElements()}reRendering(t,i,r){const{adRotator:s,elementHider:n,clickThroughPlayer:o}=this.generateSubscribers(i,r);this.closeClickEvent.changeSubscribers([n]),this.acceptClickEvent.changeSubscribers([o,s]),this.cancelClickEvent.changeSubscribers([s]),this.pager.changeStorage(r),this.ad.rendering(t,r.getSize()),this.pager.receive();const l=this.microadCompass.selectMicroadCompassFrequency();this.fireImpressionBeacon(r.getImpressionTag(),l,i,r,!1)}generateSubscribers(t,i){const r=new z(t,i,this.microadCompass.selectAudienceIds()),s=new U(i.getEncryptedSpotId()),n=new oe("compassSpotTemplateAdWrapper",this.microadCompass).create(i);return{adRotator:r,elementHider:s,clickThroughPlayer:n}}fireImpressionBeacon(t,i,r,s,n){new j(t,i,r,s==null?void 0:s.getAd().html,s==null?void 0:s.getFrequencyParams(),"compassSpotTemplateFrame",n).receive()}}const le=(a,e)=>{const t=a.selectMicroadCompassOverridingHandler();(t==null?void 0:t.onAdLoaded)!=null&&t.onAdLoaded(),(t==null?void 0:t.onRedirect)!=null&&new J(new y(e.getEncryptedSpotId()),t.onRedirect).addListener()},N={rendering:(a,e,t,i)=>{var n;const r=new ce(e,t,t.getTemplate("main"),i);i.registerTemplateByImpression(a,"main",r);const s=(n=i.selectTemplate(a))==null?void 0:n.main;s!=null&&(s.rendering(e,t),le(i,t))},reRendering:(a,e,t)=>{a.reRendering(t.getAd(),e,t)}};class he{constructor(e,t,i,r,s=new y(t.getEncryptedSpotId())){this.adRequest=e,this.adResponse=t,this.microadCompassTemplate=i,this.templateRender=r,this.templateFrameRepository=s}receive(){this.templateFrameRepository.deleteAllBodyChildrenElements(),this.templateRender(this.adResponse.getImpressionId(),this.adRequest,this.adResponse,this.microadCompassTemplate)}}class me extends H{constructor(t,i,r,s){if(!(r!=null&&r.html))throw new Error("[COMPASS-JS] Cant find template's HTML. therefore, advertisement is not display.");super();c(this,"acceptClickEvent");c(this,"frame");this.microadCompass=s;const n=i.isOverlay();this.frame=new V(r,i.getEncryptedSpotId(),n?K:{},n);const o=this.generateSubscribe(t,i);this.acceptClickEvent=new A([o])}generateSubscribe(t,i){return new he(t,i,this.microadCompass,N.rendering)}rendering(){this.frame.rendering()}}const X={rendering:(a,e,t,i)=>{var n;const r=new me(e,t,t.getTemplate("confirm"),i);i.registerTemplateByImpression(a,"confirm",r);const s=(n=i.selectTemplate(a))==null?void 0:n.confirm;s!=null&&s.rendering()}};class ue{constructor(e,t,i,r,s,n,o,l,h,d,g,f,v,w,E,C,R,O,G,W){this.spot=e,this.callback=t,this.url=i,this.urlMacro=r,this.referrer=s,this.referrerMacro=n,this.ifa=o,this.appId=l,this.geo=h,this.vo=d,this.mimes=g,this.rtus=f,this.audiences=v,this.clientCints=w,this.cashBuster=E,this.protectedAudience=C,this.attributionReporting=R,this.version=O,this.fc=G,this.kvSet=W}getEncryptedSpotId(){return this.spot}createRequestURL(e,t){const i={spot:this.spot,cb:this.callback,url:this.url,url_macro:this.urlMacro,referrer:this.referrer,referrer_macro:this.referrerMacro,ifa:this.ifa,appid:this.appId,geo:this.geo,vo:this.vo,mimes:this.mimes,rtus:this.rtus,aids:[...t],ch:this.clientCints,cbt:this.cashBuster,pa:this.protectedAudience,ar:this.attributionReporting,ver:this.version,fc:this.fc};return Object.entries({...i,...e}).reduce((s,[n,o])=>(o instanceof(Object||Array)?Object.keys(o).length>0&&s.push(this.encodeURIParameter(n,JSON.stringify(o))):o&&s.push(this.encodeURIParameter(n,o)),s),[]).join("&")}createFrequencyCustomKeyParameters(e){if(this.kvSet==null)return{};const t=Object.entries(this.kvSet);return e.reduce((i,r)=>{var n;const s=(n=t.find(([o])=>o===r))==null?void 0:n[1];return s!=null&&(i[r]=s),i},{})}encodeURIParameter(e,t){return`${e}=${encodeURIComponent(t)}`}}class b{of(e){return new ue(e.spot,e.cb,e.url,e.url_macro,e.referrer,e.referrer_macro,e.ifa,e.appid,e.geo,e.vo,e.mimes,e.rtus,e.aids,e.ch,e.cbt,e.pa,e.ar,e.ver,e.fc,e.kv_set)}}const p=class p{static convertDomain(e,t=new URL(document.URL)){if(e==="")throw new Error("[COMPASS-JS] Invalid domain. therefore, advertisement is not display.");const i=e.replace("{","").replace("}","");if(i==="FQDN")return t.host;const r=Number(i);return Number.isInteger(r)?p.createTopLevelDomainPlusAny(r):e}static createTopLevelDomainPlusAny(e,t=new URL(document.URL).hostname){if(e<1)throw new Error("[COMPASS-JS] Number of domain pattern is less than 1. therefore, advertisement is not display.");const i=p.createTopLevelDomainPlusOne(t);if(e===1)return i;const r=t.replace(i,"").split(".").slice(-e).join(".");return r?`${r}${i}`:i}static createTopLevelDomainPlusOne(e=new URL(document.URL).hostname){const t=e.split(".");for(let i=2;i<=t.length;i+=1){const r=t.slice(-i).join(".");if(document.cookie=this.createCookie(r),p.isExist(p.testCookieName))return document.cookie=this.createCookie(r,0),r}return e}static createCookie(e,t=p.testExpireSeconds){return`${`${p.testCookieName}=${p.testValue}`}; domain=${e}; path=/; max-age=${t}`}static isExist(e){return document.cookie.split(";").map(t=>{const[i,r]=t.split("=");return{key:i.trim(),value:r}}).some(t=>t.key===e)}};c(p,"testCookieName","mtcn"),c(p,"testValue","mtcnv"),c(p,"testExpireSeconds",10);let q=p;class B{constructor(e,t,i,r,s,n,o,l,h,d,g,f,v,w,E){this.impressionId=e,this.impressionUrls=t,this.encryptedSpotId=i,this.encryptedAdPing=r,this.creativeType=s,this.templates=n,this.width=o,this.height=l,this.sequence=h,this.rotationMax=d,this.aspectRatioId=g,this.advertiserDomain=f,this.displayedIds=v,this.display=w,this.frequency=E}getImpressionId(){return this.impressionId}getEncryptedSpotId(){return this.encryptedSpotId}getEncryptedAdPing(){return this.encryptedAdPing}getCreativeType(){return this.creativeType}getImpressionUrls(){return this.impressionUrls}getTemplate(e){return this.templates?this.templates[e]:void 0}getSize(){const e=this.width!=null&&this.width>0,t=this.height!=null&&this.height>0;return e&&t?{width:this.width,height:this.height}:void 0}getSequence(){return this.sequence}getRotationMax(){return this.rotationMax==null?void 0:this.rotationMax}isExecutableRotation(){const e=this.getRotationMax(),t=this.getSequence();return e==null||t==null?!1:e+1>=t}createRotationParams(){return{impression_id:this.impressionId,creative_type:this.creativeType,sequence:String(this.sequence),aspect_ratio_id:this.aspectRatioId,adomains:this.advertiserDomain?JSON.parse(this.advertiserDomain)||[]:void 0,displayed_ids:this.displayedIds,frequency:this.frequency}}isOverlay(){return this.display==="overlay"||this.display==="interstitial"}getFrequencyParams(){if(this.frequency!=null)return{key:this.frequency.key,domain:q.convertDomain(this.frequency.domain),rewardedSec:this.frequency.rewarded_sec}}}class de extends B{constructor(e,t,i,r,s,n,o,l,h,d,g,f,v,w,E,C){super(e,i,r,s,n,h,void 0,void 0,d,g,f,v,w,E,C),this.impressionTag=t,this.adTag=o,this.nativeCss=l}getAd(){return{html:this.adTag,css:this.nativeCss,js:""}}getImpressionId(){return this.impressionId}getEncryptedSpotId(){return this.encryptedSpotId}getImpressionTag(){return this.impressionTag}getLandingPageUrl(){}getClickTrackingUrls(){}}class pe extends B{constructor(e,t,i,r,s,n,o,l,h,d,g,f,v,w,E,C,R){super(e,i,r,s,n,l,h,d,g,f,v,w,E,C,R),this.impressionTag=t,this.adTag=o}getAd(){return{html:this.adTag,css:"",js:""}}getImpressionTag(){return this.impressionTag}getLandingPageUrl(){}getClickTrackingUrls(){}}class ye extends B{constructor(e,t,i,r,s,n,o,l,h,d,g,f,v,w,E,C,R,O){super(e,t,i,r,s,o,l,h,d,g,f,v,w,E,O),this.adTag=n,this.landingPageUrl=C,this.clickTrackingUrls=R}getAd(){return{html:this.adTag,css:"",js:""}}getImpressionTag(){}getLandingPageUrl(){return this.landingPageUrl}getClickTrackingUrls(){return this.clickTrackingUrls}}const m={NOT_EXIST:2e4,EMPTY:20001,NOT_A_NUMBER:20002,NEGATIVE_NUMBER:20003,INVALID_SPECIFICATION:20004};class u extends Error{constructor(t,i,r){super(t);c(this,"reportingMessage");this.message=t,this.errorCode=i,this.withItems=r,this.reportingMessage=this.convertForReportMessage()}convertForReportMessage(){let t="";switch(this.errorCode){case m.NOT_EXIST:t=`Cant find value (${this.message})`;break;case m.EMPTY:t=`Value is empty string (${this.message})`;break;case m.NOT_A_NUMBER:t=`Value is not a number (${this.message})`;break;case m.NEGATIVE_NUMBER:t=`Value is negative number (${this.message})`;break;case m.INVALID_SPECIFICATION:t=`Value is invalid (${this.message})`;break;default:t=this.message}if(this.withItems==null)return t;const i=this.withItems.join(",").trim();return`${t} with ${i}`}}class k{of(e){var d;const t=this.validateImpressionId(e.impression_id),i=this.validateSpotId(e.spot),r=this.validateSequence(e.sequence);if(e.frequency&&this.isCollectFrequencyParams(e.frequency),!e.adtag)return;const s=this.validateRotationMax(e.rotation_max,e.adtag),n=this.validateEp(e.ep),o=e.width!=null?Number(e.width):void 0,l=e.height!=null?Number(e.height):void 0,h=Array.isArray(e.imp_urls)?e.imp_urls:[];switch(e.creative_type){case"banner":return new pe(t,e.imptag,h,i,n,e.creative_type,e.adtag,e.templates,o,l,r,s,e.aspect_ratio_id,e.adomains,e.displayed_ids,e.display,e.frequency);case"native":return new de(t,e.imptag,h,i,n,e.creative_type,e.adtag,e.nativecss,e.templates,r,s,e.aspect_ratio_id,e.adomains,e.displayed_ids,e.display,e.frequency);case"video":return this.validateClickThroughUrl(e),new ye(t,h,i,n,e.creative_type,e.adtag,e.templates,o,l,r,s,e.aspect_ratio_id,e.adomains,e.displayed_ids,e.display,e.ext.click_through_url,((d=e.ext)==null?void 0:d.click_tracking_urls)||[],e.frequency);default:return}}validateImpressionId(e){if(e==null)throw new u("impression_id",m.NOT_EXIST);return e}validateSpotId(e){if(e==null)throw new u("spot",m.NOT_EXIST);return e}validateClickThroughUrl(e){var t;if(e.creative_type!=="video")return"";if(!((t=e.ext)!=null&&t.click_through_url))throw new u("ext.click_through_url",m.NOT_EXIST);return e.ext.click_through_url}validateSequence(e){if(e==null)throw new u("sequence",m.NOT_EXIST);const t=Number(e);if(Number.isNaN(t))throw new u("sequence",m.NOT_A_NUMBER);return t}validateEp(e){if(e==null)throw new u("ep",m.NOT_EXIST);return e}validateRotationMax(e,t){if(e==null){if(t==null)return;throw new u("rotation_max",m.NOT_EXIST,["adtag"])}const i=Number(e);if(Number.isNaN(i))throw new u("rotation_max",m.NOT_A_NUMBER);return i}getFrequencyParam(e){if(this.validateImpressionId(e.impression_id),this.validateSpotId(e.spot),this.validateSequence(e.sequence),this.validateRotationMax(e.rotation_max,e.adtag),this.validateClickThroughUrl(e),e.frequency!=null)return this.isCollectFrequencyParams(e.frequency),{key:e.frequency.key,domain:q.convertDomain(e.frequency.domain),rewardedSec:Number(e.frequency.rewarded_sec)}}isCollectFrequencyParams(e){if(e.key==null)throw new u("frequency.key",m.NOT_EXIST);if(e.domain==null)throw new u("frequency.domain",m.NOT_EXIST);if(e.rewarded_sec==null)throw new u("frequency.rewarded_sec",m.NOT_EXIST);if(e.domain==="")throw new u("frequency.domain",m.EMPTY);const t=Number(e.domain.replace("{","").replace("}",""));if(Number.isInteger(t)&&t<1)throw new u("frequency.domain",m.INVALID_SPECIFICATION);const i=Number(e.rewarded_sec);if(Number.isNaN(i))throw new u("frequency.rewarded_sec",m.NOT_A_NUMBER);if(i<0)throw new u("frequency.rewarded_sec",m.NEGATIVE_NUMBER);return!0}}class ge{constructor(e){c(this,"adResponseAdapter");c(this,"adRequestAdapter");this.microadCompass=e,this.adRequestAdapter=new b,this.adResponseAdapter=new k}renderingAnyTemplate(e,t){var o;const i=t.getImpressionId(),r=(o=this.microadCompass.selectTemplate(i))==null?void 0:o.main,s=t.getTemplate("main"),n=t.getTemplate("confirm");if(r!=null)N.reRendering(r,e,t);else if(n!=null&&s!=null)X.rendering(i,e,t,this.microadCompass);else if(s!=null)N.rendering(i,e,t,this.microadCompass);else throw new Error("[COMPASS-JS] Cant find required template's HTML. therefore, advertisement is not display.")}hideTemplate(e){const t=this.microadCompass.selectTemplate(e.impression_id),i=t==null?void 0:t.main,r=t==null?void 0:t.confirm;i!=null&&i.hideTemplate(e.spot),r!=null&&r.hideTemplate(e.spot)}rendering(e,t){var i;try{const r=this.adRequestAdapter.of(e),s=this.adResponseAdapter.of(t);s!=null?this.renderingAnyTemplate(r,s):(new j(t.imptag,this.microadCompass.selectMicroadCompassFrequency(),r,void 0,void 0,void 0,!((i=this.microadCompass.selectTemplate(t.impression_id))!=null&&i.main)).receive(),this.hideTemplate(t))}catch(r){throw this.hideTemplate(t),e.spot&&this.microadCompass.selectMicroadCompassFrequency().cancel(e.spot),new Error(r.message)}}}class L{constructor(e){this.urls=e}receive(){const e=new _(this.urls).createByURL();e==null||e.fire()}}class fe{createElement(e,t){const i=document.createElement(e);return t==null||Object.entries(t).forEach(([r,s])=>{r in i.style&&i.style[r]!=null&&(i.style[r]=s)}),i}insertScriptText(e,t){t.forEach(i=>{e.insertAdjacentText("beforeend",i)})}}class ve{constructor(e,t,i=new fe){this.adRequest=e,this.adResponse=t,this.repository=i}load(){const e={width:"0px",height:"0px",display:"none"},t=this.repository.createElement("div",e),i=this.repository.createElement("script");t.appendChild(i),this.writeScriptText(i),this.writeWrapperTag(t),document.body.appendChild(t)}writeScriptText(e){const t=["window.microadCompassWrapperRequest = window.microadCompassWrapperRequest || {};",`window.microadCompassWrapperRequest.request = ${JSON.stringify(this.adRequest)};`,`window.microadCompassWrapperRequest.response = ${JSON.stringify(this.adResponse)};`];this.repository.insertScriptText(e,t)}writeWrapperTag(e){const t=document.createRange().createContextualFragment(this.adResponse.adtag);Array.from(t.children).forEach(i=>{e.insertAdjacentElement("beforeend",i)})}}const S=class S{constructor(){try{S.consoleLog=e=>{e!=null&&console.log(e)}}catch{S.consoleLog=()=>{}}}static log(e){S.isDebugMode()&&S.consoleLog(`【DEBUG】${e}`)}static isDebugMode(){return"false".toLowerCase()==="true"}};c(S,"consoleLog");let T=S;new T;class F{static execute(e,t,i){if(!(!e||!t))try{const r="https://deb.send.microad.jp/adtag_error",s=F.createParameter(e,t,i.errorCode,i.reportingMessage);new Image().src=`${encodeURI(r)}?${s}`}catch(r){r instanceof Error&&T.log(r.message)}}static createParameter(e,t,i,r){const s={ep:e,ct:t,ver:"0.6.0",ec:i,etc:r,test:F.isDebugMode()?1:0};return Object.entries(s).filter(([n,o])=>o!=null).map(([n,o])=>`${n}=${encodeURIComponent(String(o))}`).join("&")}static isDebugMode(){return"false".toLowerCase()==="true"}}class we{constructor(e,t=new b,i=new k){this.microadCompass=e,this.adRequestAdapter=t,this.adResponseAdapter=i}load(e,t){try{this.adRequestAdapter.of(e),this.adResponseAdapter.of(t)==null?(T.log("NoAdであるため広告描画を終了します。"),this.executeNoAdProcess(t)):new ve(e,t).load()}catch(i){this.forceQuitDisplay(t,i)}}executeNoAdProcess(e){new L(e.imp_urls||[]).receive(),this.hideTemplate(e.spot,e.impression_id)}forceQuitDisplay(e,t){const i=t instanceof u,r=i?t.reportingMessage:"詳細情報なし";T.log(`エラーが発生したため広告描画を終了します。(${r})`),i&&F.execute(e.ep,e.creative_type,t),this.hideTemplate(e.spot,e.impression_id)}hideTemplate(e,t){var r,s;const i=this.microadCompass.selectTemplate(t);(r=i==null?void 0:i.main)==null||r.hideTemplate(e),(s=i==null?void 0:i.confirm)==null||s.hideTemplate(e)}}class Ee{constructor(e,t,i,r,s=2e3,n=()=>"",o=()=>"",l=()=>"",h=()=>"",d=()=>"",g=()=>"",f=new y(i.getEncryptedSpotId())){this.microadCompass=e,this.wrapper=r,this.timeout=s,this.onReadyProcess=n,this.onGrantedProcess=o,this.onCloseProcess=l,this.onTimeout=h,this.onError=d,this.onDisplayed=g,this.templateFrameRepository=f,this.onReadyProcess=this.displayConfirmTemplate.bind(this,t,i),this.onGrantedProcess=this.grantReward.bind(this,t,i),this.onDisplayed=this.fireImpression.bind(this,i),this.onCloseProcess=this.removeUnNecessaryElement.bind(this),this.onTimeout=this.removeUnNecessaryElement.bind(this),this.onError=v=>this.reporting.bind(void 0,i)(v)}async ready(){await this.wrapper.loading(),this.wrapper.enableService(this.timeout,this.onReadyProcess,this.onGrantedProcess,this.onCloseProcess,this.onTimeout,this.onError,window)}displayConfirmTemplate(e,t){if(t.getTemplate("confirm")==null){this.display();return}X.rendering.bind(void 0,t.getImpressionId(),e,t,this.microadCompass)();const i=this.templateFrameRepository.selectElement("compassSpotTemplateNextTemplateButton");i!=null&&(i.onclick=this.display.bind(this))}display(){this.wrapper.display(this.onDisplayed),this.templateFrameRepository.hideFrameElement()}fireImpression(e){new L(e.getImpressionUrls()).receive()}grantReward(e,t){const i=this.microadCompass.selectMicroadCompassFrequency(),r=t.getFrequencyParams();if(r==null)return;const{key:s,domain:n}=r,o=t.getEncryptedSpotId(),l=i.getCustomKeyValues(e,s),h=i.selectFrequency(o,l,n);h==null||h.resetFrequency(i.generateKeyForSpot(o))}removeUnNecessaryElement(){this.templateFrameRepository.hideFrameElement.bind(this.templateFrameRepository)()}reporting(e,t){const i=e.getEncryptedAdPing(),r=e.getCreativeType(),s=new u(t,20100);F.execute(i,r,s)}}class Te{constructor(e,t=new b,i=new k){this.microadCompass=e,this.adRequestAdapter=t,this.adResponseAdapter=i}async rendering(e,t,i){T.log("外部リワード機能を用いた広告描画を開始します。");try{const r=this.adRequestAdapter.of(e),s=this.adResponseAdapter.of(t);s==null?(T.log("NoAdであるため広告描画を終了します。"),this.executeNoAdProcess(t)):await new Ee(this.microadCompass,r,s,i).ready()}catch(r){this.forceQuitDisplay(t,r)}}executeNoAdProcess(e){new L(e.imp_urls||[]).receive(),this.hideTemplate(e.spot,e.impression_id)}forceQuitDisplay(e,t){const i=t instanceof u,r=i?t.reportingMessage:"詳細情報なし";T.log(`エラーが発生したため広告描画を終了します。(${r})`),i&&F.execute(e.ep,e.creative_type,t),this.hideTemplate(e.spot,e.impression_id)}hideTemplate(e,t){var r,s;const i=this.microadCompass.selectTemplate(t);(r=i==null?void 0:i.main)==null||r.hideTemplate(e),(s=i==null?void 0:i.confirm)==null||s.hideTemplate(e)}}class Ce{constructor(e,t={}){this.display=e,this.templates=t}selectDisplayFunc(){return this.display}selectTemplate(e){return this.templates[e]}registerTemplateByImpression(e,t,i){const r=this.templates[e];r!=null?this.templates[e]={...r,[t]:i}:this.templates[e]={[t]:i}}notify(e,t,i){var n;const r=(n=this.selectTemplate(e))==null?void 0:n[t];if(r==null){const o=`[COMPASS-JS] Cant find ${t} template's HTML. therefore, advertisement is not display.`;throw new Error(o)}const s=r[i];if(s==null)throw new Error("[COMPASS-JS] Cant find template's event. therefore, advertisement is not display.");s.notify()}}const x=class x{selectRelayData(e){return this.getCookiesFromBrowser().filter(t=>t.key===e).map(t=>{const i=JSON.parse(t.value);return{updateTime:i[0],frequencyCode:i[1]}})}selectFrequencyCode(e){return this.getCookiesFromBrowser().filter(t=>t.key===e).map(t=>{const i=JSON.parse(t.value);return{updateTime:i[0],counter:i[1],time:i[2]}})}registerRelayData(e,t,i){const r=new Date().getTime();this.writeCookie(e,`[${r}, "${t}"]`,i)}register(e){const t=e.getKey(),i=e.getCounter(),r=e.getRewardedTime(),s=new Date().getTime(),n=e.getDomain();n!=null&&this.writeCookie(t,`[${s}, ${i}, ${r}]`,n)}getCookiesFromBrowser(){var e;return document.cookie==null?[]:(e=document.cookie)==null?void 0:e.split(";").map(t=>{const[i,r]=t.split("=");return{key:i.trim(),value:r}})}writeCookie(e,t,i,r=x.cookieExpirationSec){document.cookie=`${e}=${t}; domain=${i}; max-age=${r}; path=/;`}};c(x,"cookieExpirationSec",604800);let M=x;class Se{constructor(e,t=[]){c(this,"MARKER_TEMPORARY_ID","frequency-temporary");this.id=e,this.measures=t}start(){const e=this.measures.slice(-1)[0];if(e!=null&&e.finish==null)return;const t=this.getStartId(this.measures.length);this.measures.push({start:performance.mark(t),finish:void 0})}finish(){const e=this.measures.slice(-1)[0];if((e==null?void 0:e.start)==null)return;const t=this.measures.length-1,i=this.getFinishId(t);this.measures[t].finish=performance.mark(i)}getTotalDuration(e=void 0){const t=this.measures.length-1,i=this.measures.reduce((r,s,n)=>{const o=t===n;if(s.start==null||!o&&s.finish==null)return r;s.finish==null&&(performance.clearMarks(this.MARKER_TEMPORARY_ID),performance.mark(this.MARKER_TEMPORARY_ID,e==null?void 0:{startTime:e}));const l=performance.measure(this.getResultId(n),this.getStartId(n),o&&s.finish==null?this.MARKER_TEMPORARY_ID:this.getFinishId(n));return r+l.duration},0);return Math.round(i)}reset(){this.measures=[]}getStartId(e){return`${this.getCommonId(e)}-start`}getFinishId(e){return`${this.getCommonId(e)}-finish`}getResultId(e){return`${this.getCommonId(e)}-result`}getCommonId(e){return`${this.id}-${e}`}}class Ie{constructor(e,t,i,r,s,n=new M,o=!1){c(this,"measure");c(this,"clockId");c(this,"remainingTimeId");this.id=e,this.key=t,this.counter=i,this.rewardedTime=r,this.domain=s,this.frequencyRepository=n,this.isReachedReward=o,this.measure=new Se(this.id),this.clockId=void 0,this.remainingTimeId=void 0}getKey(){return this.key}getCounter(){return this.counter}getRewardedTime(){return this.rewardedTime}getDomain(){return this.domain}countUp(e){this.counter+=1,this.frequencyRepository.registerRelayData(e,this.key,this.domain),this.frequencyRepository.register(this)}resetFrequency(e){this.counter=0,this.rewardedTime=Math.floor(new Date().getTime()/1e3),this.frequencyRepository.registerRelayData(e,this.key,this.domain),this.frequencyRepository.register(this)}reachReward(){this.isReachedReward=!0}getTotalDurationSec(){return Math.floor(this.measure.getTotalDuration()/1e3)}setTheClock(e,t,i){this.clockId=setInterval(()=>{this.clockId!=null&&(e>this.getTotalDurationSec()&&!this.isReachedReward||(this.resetFrequency(t),i(),clearInterval(this.clockId)))},1)}getRemainingTime(e){return e-this.getTotalDurationSec()}getRemainingTimeSync(e,t,i){let r=e;this.remainingTimeId=setInterval(()=>{if(this.remainingTimeId==null)return;const s=this.getRemainingTime(e);r!==s&&(r=s,t(s),!(s>0&&!this.isReachedReward)&&(i(),s<0&&t(0),clearInterval(this.remainingTimeId)))},1)}cancel(){this.clockId!=null&&(clearInterval(this.clockId),this.clockId=void 0),this.remainingTimeId!=null&&(clearInterval(this.remainingTimeId),this.remainingTimeId=void 0),this.measure.reset()}startTheClock(){this.measure.start()}finishTheClock(){this.measure.finish()}isEqual(e){return this.key===e}}const P={of:(a,e,t,i,r=0)=>new Ie(a,e,r,t,i)};class Fe{constructor(e,t,i,r=!1){c(this,"templateFrameRepository");c(this,"templateRepository");c(this,"targetWindow");c(this,"intersectionObserver");c(this,"inViewFunction");c(this,"outViewFunction");this.encryptedSpotId=e,this.inViewRate=t,this.targetElement=i,this.isInviewing=r,this.inViewFunction=void 0,this.outViewFunction=void 0,this.templateFrameRepository=new y(e),this.templateRepository=new I}connect(e,t){e();const i=()=>{this.isInviewing=!0,this.isInviewing&&e()},r=()=>{this.isInviewing=!1,this.isInviewing||t()};this.inViewFunction=i,this.outViewFunction=r,this.targetWindow=this.templateFrameRepository.selectWindow(),this.setIntersectionObserver(i,r),this.targetWindow!=null&&this.setFocusObserver(this.targetWindow,i,r)}disconnect(){var i;if((i=this.intersectionObserver)==null||i.disconnect(),this.targetWindow==null||this.inViewFunction==null||this.outViewFunction==null)return;const e=this.inViewFunction,t=this.outViewFunction;this.removeFocusEventListener(this.targetWindow,e,t),this.removeTouchMoveEventListener(this.targetWindow,e),this.removeHistoryBackEventListener(this.targetWindow,e,t)}setIntersectionObserver(e,t){this.intersectionObserver=new IntersectionObserver(i=>{const r=i.find(s=>s.target===this.targetElement);r!=null&&(r.intersectionRatio>=this.inViewRate?(this.isInviewing=!0,e()):(this.isInviewing=!1,t()))},{threshold:[this.inViewRate]}),this.intersectionObserver.observe(this.targetElement)}setFocusObserver(e,t,i){this.addFocusEventListener(e,t,i),this.addTouchMoveEventListener(e,t),this.addHistoryBackEventListener(e,t,i)}addFocusEventListener(e,t,i){this.templateRepository.activeFocusEvent(e,t,i),e!==e.top&&this.templateRepository.activeFocusEvent(e.parent,t,i)}addTouchMoveEventListener(e,t){this.templateRepository.activeTouchMoveEvent(e,t),e!==e.top&&this.templateRepository.activeTouchMoveEvent(e.parent,t)}addHistoryBackEventListener(e,t,i){this.templateRepository.activeMovePageHistoryEvent(e,t,i),e!==e.top&&this.templateRepository.activeMovePageHistoryEvent(e.parent,t,i)}removeFocusEventListener(e,t,i){this.templateRepository.inactiveFocusEvent(e,t,i),e!==e.top&&this.templateRepository.inactiveFocusEvent(e.parent,t,i)}removeTouchMoveEventListener(e,t){e.removeEventListener("touchmove",t),e!==e.top&&this.templateRepository.inactiveTouchMoveEvent(e.parent,t)}removeHistoryBackEventListener(e,t,i){e.removeEventListener("popstate",i),e!==e.top&&this.templateRepository.inactiveMovePageHistoryEvent(e.parent,t,i)}}const Re=.5,$=/\${[A-Za-z0-9]+}/g;class be{constructor(e=new M,t=void 0,i={}){c(this,"selectInsertFrequency",(e,t,i)=>{this.resetFrequencyData(e,t);const r=this.getCustomKeyValues(e,t.key),s=this.selectFrequency(i,r,t.domain);if(s==null)throw new Error("[COMPASS-JS] Cant find registered frequency cookies. therefore, advertisement is not display.");return s});this.frequencyRepository=e,this.viewableOperator=t,this.frequencies=i}getCustomKeyValues(e,t){const i=t.match($);if(i==null)return{};const r=i.map(s=>s.replace(/^\${/,"").replace(/}$/,""));return e.createFrequencyCustomKeyParameters(r)}selectFrequencyCodeKey(e,t){const i=this.generateKeyForSpot(e),r=this.getFrequencyRelay(i);return r==null?void 0:this.generateKeyForFrequency(r.frequencyCode,t)}selectFrequencyCode(e,t){const i=this.selectFrequencyCodeKey(e,t);return i==null?void 0:this.getFrequencyCode(i)}selectFrequency(e,t,i){const r=this.selectFrequencyCodeKey(e,t);if(r==null)return null;const s=this.getFrequencyCode(r);if(s==null)return null;if(this.frequencies[e]==null){const o=P.of(`${e}-${Date.now()}-frequency`,r,s.time,i,s.counter);this.registerFrequencyByEncryptedSpotId(e,o)}return this.frequencies[e]}registerFrequencyData(e,t,i){const r=P.of(`${t}-${Date.now()}-frequency`,e,null,i.domain);this.frequencyRepository.register(r)}registerFrequencyByEncryptedSpotId(e,t){this.frequencies={...this.frequencies,[e]:t}}updateCounter(e,t){const i=new b().of(e),r=i.getEncryptedSpotId(),s=new k().getFrequencyParam(t);if(r==null||s==null)return;const n=this.getCustomKeyValues(i,s.key);let o=this.selectFrequency(r,n,s.domain);o==null&&(o=this.selectInsertFrequency(i,s,r));const l=this.generateKeyForFrequency(s.key,n);o.isEqual(l)||(o=this.selectInsertFrequency(i,s,r)),o.countUp(this.generateKeyForSpot(r))}notify(e,t,i){const r=new b().of(t),s=new k().of(i);this.callRewardAcquisitionProcess(r,s==null?void 0:s.getAd().html,s==null?void 0:s.getFrequencyParams(),e)}callRewardAcquisitionProcess(e,t,i,r){const s=e.getEncryptedSpotId();if(s==null||i==null)return;const n=this.frequencies[s];if(n==null)throw new Error("[COMPASS-JS] callRewardAcquisitionProcess() has to be called after it is called updateCounter().");const o=r==null?void 0:document.getElementById(r);t&&o&&n&&(this.viewableOperator=new Fe(s,Re,o),this.viewableOperator.connect(n.startTheClock.bind(n),n.finishTheClock.bind(n)),n.setTheClock(i.rewardedSec,this.generateKeyForSpot(s),this.viewableOperator.disconnect.bind(this.viewableOperator)))}cancel(e){var i;const t=this.frequencies[e];t!=null&&(t.cancel(),(i=this.viewableOperator)==null||i.disconnect())}resetFrequencyData(e,t){const i=e.getEncryptedSpotId();if(t==null||i==null)return;const r=this.generateKeyForSpot(i),s=this.getFrequencyRelay(r);(s==null||s.frequencyCode!==t.key)&&this.frequencyRepository.registerRelayData(r,t.key,t.domain);const n=this.getFrequencyRelay(r);if(n==null)return;const o=this.getCustomKeyValues(e,t.key),l=this.generateKeyForFrequency(n.frequencyCode,o);this.getFrequencyCode(l)==null&&this.registerFrequencyData(l,i,t);const h=this.getFrequencyCode(l),d=P.of(`${i}-${Date.now()}-frequency`,l,(h==null?void 0:h.time)??null,t.domain,h==null?void 0:h.counter);this.registerFrequencyByEncryptedSpotId(i,d)}generateKeyForSpot(e){return`_mafc_${e}`}getFrequencyRelay(e){const t=this.frequencyRepository.selectRelayData(e);return t.length===0?null:t.reduce((i,r)=>i.updateTime==null||r.updateTime>i.updateTime?r:i,{})}getFrequencyCode(e){const t=this.frequencyRepository.selectFrequencyCode(e);return t.length===0?null:t.reduce((i,r)=>i.updateTime==null||r.updateTime>i.updateTime?r:i,{})}generateKeyForFrequency(e,t){const i=e.match($);return i==null?e:i.reduce((r,s)=>{const n=s.replace(/^\${/,"").replace(/}$/,""),o=t[n]==null?"":t[n];return o==null?r:r.replace(`${s}`,o)},e)}}class qe{readCookie(e){const i=this.readCookies().filter(r=>r.key===e);return i.length>0?i.slice(-1)[0].value:void 0}writeCookie(e,t,i,r){document.cookie=`${e}=${t}; domain=${i}; max-age=${r}; path=/;`}readCookies(){return document.cookie==null||document.cookie===""?[]:document.cookie.split(";").map(e=>{const[t,i]=e.split("=");return{key:(t==null?void 0:t.trim())||"",value:(i==null?void 0:i.trim())||""}})}}class ke{constructor(e="_unv_id",t=q.createTopLevelDomainPlusOne(),i=60*60,r=new qe){this.key=e,this.domain=t,this.maxAge=i,this.trackerRepository=r}write(e){this.trackerRepository.writeCookie(this.key,e,this.domain,this.maxAge)}read(){return this.trackerRepository.readCookie(this.key)}}class Ae{constructor(e=new ke){this.universeIdTracker=e}write(e,t){switch(e){case 21:return t==null?void 0:(this.universeIdTracker.write(t),this.read(e));default:return}}read(e){switch(e){case 21:return this.universeIdTracker.read();default:return}}}class Me{constructor(){c(this,"microadCompass");const e=window;if(this.microadCompass=e.microadCompass==null?{}:e.microadCompass,e.microadCompass=this.microadCompass,!this.microadCompass.ad){const t=new ge(this);this.microadCompass.ad=new Ce(t.rendering.bind(t))}if(this.microadCompass.frequency||(this.microadCompass.frequency=new be),this.microadCompass.aids||(this.microadCompass.aids=[]),this.microadCompass.audience||(this.microadCompass.audience=new Ae),!this.microadCompass.loadAdNonIframeDisplay){const t=new we(this);this.microadCompass.loadAdNonIframeDisplay=t.load.bind(t)}if(!this.microadCompass.displayExternalReward){const t=new Te(this);this.microadCompass.displayExternalReward=t.rendering.bind(t)}}selectDisplayFunc(){return this.microadCompass.ad.selectDisplayFunc()}selectTemplate(e){return this.microadCompass.ad.selectTemplate(e)}selectAudienceIds(){return this.microadCompass.aids||[]}selectMicroadCompassFrequency(){return this.microadCompass.frequency}registerTemplateByImpression(e,t,i){this.microadCompass.ad.registerTemplateByImpression(e,t,i)}selectMicroadCompassOverridingHandler(){return this.microadCompass.overridingHandler}}new Me;
